# Linux Sentry: eBPF-based File Access Monitor & Blocker

è¿™æ˜¯ä¸€ä¸ªåŸºäºŽ eBPF (CO-RE) çš„ Linux æ–‡ä»¶è®¿é—®ç›‘æŽ§ä¸Žé˜²å¾¡å®žéªŒé¡¹ç›®ã€‚
å®ƒè¿è¡Œåœ¨ Linux 6.8+ å†…æ ¸ä¸Šï¼Œèƒ½å¤Ÿå®žæ—¶æ‹¦æˆªå¯¹æ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚ `/etc/shadow`ï¼‰çš„è®¿é—®ï¼Œå¹¶åœ¨ç”¨æˆ·æ€æä¾›äº¤äº’å¼çš„â€œå…è®¸/æ‹’ç»â€æŽ§åˆ¶ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

*   **å†…æ ¸æ€æ„ŸçŸ¥**ï¼šä½¿ç”¨ `tracepoint` æŒ‚è½½ `sys_enter_openat` å’Œ `sys_enter_execve`ã€‚
*   **å®žæ—¶æ‹¦æˆª**ï¼šæ£€æµ‹åˆ°é«˜å±æ–‡ä»¶è®¿é—®ï¼ˆå¦‚å†™æ“ä½œæˆ–è®¿é—® `/etc/shadow`ï¼‰æ—¶ï¼Œè‡ªåŠ¨å‘é€ `SIGSTOP` æš‚åœç›®æ ‡è¿›ç¨‹ã€‚
*   **ç”¨æˆ·äº¤äº’**ï¼šç®¡ç†å‘˜åœ¨ç»ˆç«¯æ”¶åˆ°å‘Šè­¦ï¼Œè¾“å…¥ `y/n` å†³å®šæ”¾è¡Œæˆ–ç»ˆæ­¢è¿›ç¨‹ã€‚
*   **CO-RE æž¶æž„**ï¼šä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œã€‚
*   **é™æ€é“¾æŽ¥ Libbpf**ï¼šè‡ªå¸¦æœ€æ–°ç‰ˆ `libbpf`ï¼Œè§£å†³ç³»ç»Ÿåº“ç‰ˆæœ¬è¿‡ä½Žå¯¼è‡´çš„ BTF å…¼å®¹æ€§é—®é¢˜ã€‚

## ðŸ› ï¸ çŽ¯å¢ƒè¦æ±‚

*   **OS**: Linux (æŽ¨è Ubuntu 22.04/24.04)
*   **Kernel**: 5.10+ (å·²åœ¨ 6.8.0-87-generic éªŒè¯)
*   **Tools**: clang, llvm, make, git, bpftool, libelf-dev


## ðŸ“‚ ç›®å½•ç»“æž„

*   `src/bpf/`: eBPF å†…æ ¸æ€ä»£ç  (`.bpf.c`) å’Œ `vmlinux.h`ã€‚
*   `src/user/`: ç”¨æˆ·æ€åŠ è½½å™¨ä¸Žäº¤äº’é€»è¾‘ä»£ç ã€‚
*   `src/libbpf/`: åµŒå…¥çš„ libbpf æºç ï¼ˆç”¨äºŽé™æ€é“¾æŽ¥ï¼‰ã€‚
*   `build/`: ç¼–è¯‘äº§ç‰©ã€‚
```text
linux_sentry/
â”œâ”€â”€ .gitignore               # (æ–°å¢ž) Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ Makefile                 # (æœ€ç»ˆç‰ˆ) åŒ…å« libbpf é™æ€ç¼–è¯‘é€»è¾‘
â”œâ”€â”€ README.md                # (æ–°å¢ž) é¡¹ç›®è¯´æ˜Žæ–‡æ¡£
â””â”€â”€ src/
    â”œâ”€â”€ libbpf/              # (ç©ºæ–‡ä»¶å¤¹ï¼Œç¨åŽä½œä¸º git submodule æˆ– clone æ”¾å…¥)
    â”œâ”€â”€ bpf/
    â”‚   â””â”€â”€ linux_sentry.bpf.c
    â””â”€â”€ user/
        â””â”€â”€ main.c
```


## ðŸš€ å¿«é€Ÿå¼€å§‹


### 1. å®‰è£…ä¾èµ–

```bash
sudo apt update
sudo apt install clang llvm libelf-dev make git linux-tools-$(uname -r) linux-headers-$(uname -r)
```

### 2. å…‹éš†é¡¹ç›®ä¸Ž Libbpf

æœ¬é¡¹ç›®ä¾èµ–æœ€æ–°ç‰ˆ `libbpf`ï¼Œéœ€è¦å°†å…¶å…‹éš†åˆ°æœ¬åœ°ç›®å½•ï¼š

```bash
# å¦‚æžœä½ æ˜¯ clone çš„è¿™ä¸ªä»“åº“ï¼Œè¯·æ›´æ–° submodule
# git submodule update --init --recursive

# å¦‚æžœæ˜¯æ‰‹åŠ¨æ­å»ºï¼Œè¯·æ‰§è¡Œï¼š
mkdir -p src/libbpf
git clone https://github.com/libbpf/libbpf.git src/libbpf
```

### 3. ç”Ÿæˆ vmlinux.h

ç”Ÿæˆå½“å‰å†…æ ¸çš„å¤´æ–‡ä»¶ï¼ˆCO-RE æ ¸å¿ƒä¾èµ–ï¼‰ï¼š

```bash
make vmlinux
```

### 4. ç¼–è¯‘

æ‰§è¡Œ `make` å°†è‡ªåŠ¨ç¼–è¯‘æœ¬åœ° libbpf å¹¶æž„å»ºé¡¹ç›®ï¼š

```bash
make
```

ç¼–è¯‘æˆåŠŸåŽï¼Œå°†åœ¨ `build/` ç›®å½•ä¸‹ç”Ÿæˆï¼š
*   `linux_sentry` (ç”¨æˆ·æ€æŽ§åˆ¶ç¨‹åº)
*   `linux_sentry.bpf.o` (å†…æ ¸æ€ BPF å­—èŠ‚ç )

### 5. è¿è¡Œ

**æ³¨æ„**ï¼šåŠ è½½ eBPF ç¨‹åºéœ€è¦ root æƒé™ã€‚

```bash
sudo ./build/linux_sentry
```

## ðŸ§ª å®žéªŒéªŒè¯

ä¿æŒ `linux_sentry` è¿è¡Œï¼Œæ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£è¿›è¡Œæµ‹è¯•ã€‚

**æµ‹è¯• 1ï¼šæ™®é€šè®¿é—®ï¼ˆè§¦å‘ INFO æ—¥å¿—ï¼‰**
```bash
cat /etc/passwd
```
*ç»“æžœ*ï¼šSentry ç»ˆç«¯æ˜¾ç¤º `[INFO] ...`ï¼Œæ“ä½œæ­£å¸¸æ”¾è¡Œã€‚

**æµ‹è¯• 2ï¼šé«˜å±è®¿é—®ï¼ˆè§¦å‘æ‹¦æˆªï¼‰**
```bash
sudo cat /etc/shadow
```
*ç»“æžœ*ï¼š
1.  `cat` å‘½ä»¤å¡ä½ï¼ˆè¿›ç¨‹è¢«æŒ‚èµ·ï¼‰ã€‚
2.  Sentry ç»ˆç«¯æç¤ºï¼š`Allow process ...? [y/N]`ã€‚
3.  è¾“å…¥ `n` -> è¿›ç¨‹è¢«ç»ˆæ­¢ï¼›è¾“å…¥ `y` -> è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚

